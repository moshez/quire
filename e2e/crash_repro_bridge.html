<!DOCTYPE html>
<html>
<head><title>Bridge Crash Repro</title></head>
<body>
<h1>Bridge Crash Repro</h1>
<p>Uses the REAL ward bridge with DOM manipulation, then calls
crash_repro_render() which exercises render_tree_with_images.</p>
<div id="root"></div>
<pre id="log"></pre>
<script type="module">
import { loadWard } from '../vendor/ward/lib/ward_bridge.mjs';

const log = document.getElementById('log');
function logMsg(msg) {
  log.textContent += msg + '\n';
  console.log(msg);
}

async function run() {
  logMsg('Loading quire.wasm via real ward bridge...');

  const root = document.getElementById('root');
  const response = await fetch('../build/quire.wasm');
  const bytes = await response.arrayBuffer();

  let ward;
  try {
    ward = await loadWard(bytes, root);
  } catch (e) {
    logMsg(`loadWard error: ${e.message}`);
    document.title = 'ERROR';
    return;
  }

  const { exports } = ward;
  logMsg(`Bridge loaded. Memory: ${exports.memory.buffer.byteLength} bytes`);
  logMsg(`Root children: ${root.childElementCount}`);

  // Phase 1: Warm up the render loop (200 calls).
  // Each call creates real DOM elements via the bridge.
  const WARMUP = 200;
  logMsg(`Phase 1: warming up (${WARMUP} calls with real DOM)...`);
  try {
    for (let i = 0; i < WARMUP; i++) {
      exports.crash_repro_render();
    }
    logMsg(`Phase 1 done. Root children: ${root.childElementCount}`);
  } catch (e) {
    logMsg(`Phase 1 ERROR: ${e.message}`);
    document.title = 'ERROR';
    return;
  }

  // Phase 2: Call from async context.
  logMsg('Phase 2: calling from async context...');
  await new Promise((resolve) => {
    setTimeout(() => {
      try {
        const ret = exports.crash_repro_render();
        logMsg(`Phase 2: returned ${ret}`);
        logMsg('NO CRASH');
        document.title = 'PASS';
      } catch (e) {
        logMsg(`Phase 2 ERROR: ${e.message}`);
        document.title = 'ERROR';
      }
      resolve();
    }, 100);
  });
}

run().catch(e => {
  logMsg(`FATAL: ${e.message}`);
  document.title = 'ERROR';
});
</script>
</body>
</html>
