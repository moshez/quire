<!DOCTYPE html>
<html>
<head>
<title>crash_repro ward#18</title>
<style>
/* Exact quire reader CSS â€” mapped from class selectors to structural
   selectors since crash_repro doesn't set class attributes.
   #ward-root > div = .reader-viewport (node 1)
   #ward-root > div > div = .chapter-container (node 2)
   Decoded from quire.dats fill_css_reader + fill_css_content _w4 writes. */
#ward-root > div {
  position: relative;
  height: calc(100vh - 3.5rem);
  overflow: hidden;
}
#ward-root > div > div {
  column-width: 100vw;
  column-gap: 0;
  padding: 2rem 0;
  overflow: hidden;
  height: 100%;
}
#ward-root > div > div > * {
  padding-left: 1.5rem;
  padding-right: 1.5rem;
  box-sizing: border-box;
}
#ward-root > div > div h1,
#ward-root > div > div h2,
#ward-root > div > div h3 {
  margin-top: 1.5em;
  margin-bottom: .5em;
  line-height: 1.3;
}
#ward-root > div > div p {
  margin: 0 0 .8em;
  text-align: justify;
}
#ward-root > div > div blockquote {
  margin: 1em 2em;
  padding-left: 1em;
  border-left: 3px solid #ccc;
  color: #555;
}
#ward-root > div > div pre {
  background: #f4f4f4;
  padding: .8em;
  border-radius: 4px;
  overflow-x: auto;
  font-size: .9em;
}
#ward-root > div > div code {
  background: #f4f4f4;
  padding: .1em .3em;
  border-radius: 2px;
  font-size: .9em;
}
#ward-root > div > div img {
  max-width: 100%;
  height: auto;
}
#ward-root > div > div a {
  color: #4a7c59;
}
#ward-root > div > div table {
  border-collapse: collapse;
  margin: 1em 0;
}
#ward-root > div > div td,
#ward-root > div > div th {
  border: 1px solid #ddd;
  padding: .4em .8em;
}
</style>
</head>
<body>
<div id="ward-root"></div>
<pre id="log"></pre>
<script type="module">
import { loadWard } from './../lib/ward_bridge.mjs';

const log = document.getElementById('log');
function logMsg(msg) {
  log.textContent += msg + '\n';
  console.log(msg);
}

async function main() {
  logMsg('Loading crash_repro.wasm...');
  const root = document.getElementById('ward-root');
  // In CI, crash_repro.wasm is at /crash-repro.wasm (copied from build artifact).
  // Locally, try vendor/ward/build/ first, fallback to root.
  let resp = await fetch('/crash-repro.wasm').catch(() => null);
  if (!resp || !resp.ok)
    resp = await fetch('./../build/crash_repro.wasm');
  const wasmBytes = await resp.arrayBuffer();

  logMsg('Instantiating...');
  const { exports, nodes, done } = await loadWard(wasmBytes, root);

  logMsg('Running...');
  await done;

  logMsg('Done! nodes=' + nodes.size);
  const viewport = root.firstElementChild;
  const container = viewport?.firstElementChild;
  logMsg('children=' + (container?.childElementCount ?? 0));
  logMsg('innerHTML.length=' + root.innerHTML.length);
  logMsg('SUCCESS');
}

main().catch(err => logMsg('FATAL: ' + err.message));
</script>
</body>
</html>
